<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saint Aubin International - Control Presupuestal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* === ESTILOS G&C === */
        :root {
            --primary: #002B5C;       /* Azul Oscuro */
            --accent: #00A3E0;        /* Azul Celeste */
            --bg: #F4F7FA;            /* Fondo */
            --white: #ffffff;
            --text: #2C3E50;
            --danger: #D32F2F;
            --success: #2E7D32;
            --warning: #F39C12;
        }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--text); font-size:14px; }
        .container { max-width: 1300px; margin: 0 auto; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 3px solid var(--accent); padding-bottom: 15px; }
        .brand h1 { margin: 0; font-size: 1.8rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .brand span { color: var(--accent); font-weight: 300; }
        
        /* CARDS */
        .card { background: var(--white); padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,43,92,0.08); margin-bottom: 20px; border: 1px solid #e1e8ed; }
        .card h2 { margin-top: 0; color: var(--primary); font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; font-weight: 700; }
        .card.transfer-zone { border-top: 4px solid var(--warning); }
        .card.transfer-zone h2 { color: var(--warning); }

        /* LAYOUT */
        .grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; }
        .grid-dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 20px; }
        @media(max-width:900px){ .grid, .grid-dashboard { grid-template-columns: 1fr; } }
        
        /* INPUTS */
        input, select { width: 100%; padding: 12px; border: 1px solid #ccd6dd; border-radius: 4px; margin-bottom: 15px; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(0,163,224,0.1); }
        label { font-weight: 600; color: var(--primary); display: block; margin-bottom: 5px; font-size: 0.9em; }
        
        /* BUTTONS */
        button { padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 0.85em; transition: 0.2s; letter-spacing: 0.5px; }
        button.primary { background: var(--primary); color: white; }
        button.accent { background: var(--accent); color: white; width: 100%; font-size: 1em; }
        button.warning { background: var(--warning); color: white; width: 100%; }
        button.success { background: var(--success); color: white; font-size: 0.8em; padding: 8px 15px; }
        button.danger { background: var(--danger); color: white; padding: 4px 8px; font-size: 0.75em; border-radius: 3px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }

        /* KPIS */
        .kpi-container { display: flex; flex-direction: column; gap: 15px; height: 100%; justify-content: space-between; }
        .kpi-card { background: white; padding: 20px; border-radius: 8px; text-align: center; border-left: 5px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .kpi-item small { color: #7f8c8d; font-weight: 700; text-transform: uppercase; font-size: 0.8em; letter-spacing: 1px; }
        .kpi-val { font-size: 2.2rem; font-weight: 800; color: var(--primary); margin-top: 5px; }
        
        /* TABLES */
        .table-wrap { overflow-x: auto; overflow-y: auto; max-height: 400px; border: 1px solid #e1e8ed; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; min-width: 100%; background: white; }
        th { background: var(--primary); color: white; padding: 12px 10px; text-align: left; font-weight: 600; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #f0f4f8; color: #34495e; }
        tr:hover { background-color: #f9fcff; }
        
        /* Badges */
        .badge-transfer { background: #fff3e0; color: #e67e22; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 0.85em; border: 1px solid #ffe0b2; }

        /* LOADER */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ecf0f1; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,43,92,0.6); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter: blur(3px); }
        .modal { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); border-top: 6px solid var(--danger); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from {transform: translateY(-30px); opacity:0;} to {transform: translateY(0); opacity:1;} }
        
        .transfer-box { background: #fff5f5; padding: 15px; border-radius: 5px; border: 1px solid #fed7d7; margin-top: 15px; }
    </style>
</head>
<body>

<div id="loginScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#002B5C; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white;">
    <h1 style="color:#00A3E0; margin-bottom:10px;">Saint Aubin <span style="color:white">Intranet</span></h1>
    <p style="opacity:0.8; margin-bottom:20px;">Ingreso exclusivo personal autorizado</p>
    <input type="password" id="passInput" placeholder="Contrase√±a de acceso" style="width:250px; text-align:center; padding:15px; border-radius:30px; border:none;">
    <button onclick="checkPass()" style="margin-top:20px; background:#00A3E0; color:white; border:none; padding:12px 40px; font-weight:bold; cursor:pointer; border-radius:30px; transition:0.3s;">ENTRAR</button>
    <p id="loginMsg" style="color:#ff6b6b; margin-top:15px; display:none; font-weight:bold;">‚ö†Ô∏è Contrase√±a Incorrecta</p>
</div>

<script>
    function checkPass() {
        const p = document.getElementById('passInput').value;
        if(p === "SaintAubin2025") {
            document.getElementById('loginScreen').style.display = 'none';
            localStorage.setItem('auth', 'true');
            unlockApp(); 
        } else {
            document.getElementById('loginMsg').style.display = 'block';
        }
    }
    function logout() {
        localStorage.removeItem('auth');
        location.reload();
    }
    // Comprobaci√≥n inicial segura
    window.onload = function() {
        if(localStorage.getItem('auth') === 'true') {
            document.getElementById('loginScreen').style.display = 'none';
            unlockApp();
        }
        
        // Seguridad anti-pantalla blanca: Si falla algo, forzar visualizaci√≥n tras 3 segs
        setTimeout(() => {
            if(document.getElementById('loginScreen').style.display === 'none') {
                document.getElementById('mainContainer').style.display = 'block';
            }
        }, 3000);
    };
</script>

<div id="loader" style="display:none;">
    <div class="spinner"></div>
    <h3 style="color:var(--primary)">Procesando...</h3>
    <p id="loadMsg" style="color:#7f8c8d">Conectando con base de datos segura...</p>
</div>

<div id="alertModal" class="modal-overlay">
    <div class="modal">
        <h3>‚ö†Ô∏è Saldo Insuficiente</h3>
        <p style="margin-bottom:5px;">El rubro no tiene fondos en <b id="modalTargetMonth" style="color:var(--primary)"></b>.</p>
        <p>Faltante: <b id="modalMissing" style="color:var(--danger); font-size:1.2em;"></b></p>
        
        <div class="transfer-box">
            <label style="color:var(--danger)">Autorizar traslado desde:</label>
            <select id="modalSourceMonth" style="background:white;"></select>
            <small style="color:#c0392b">Se descontar√° del mes seleccionado.</small>
        </div>
        
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:25px;">
            <button onclick="closeModal()" style="background:#ecf0f1; color:#7f8c8d">Cancelar</button>
            <button onclick="executeTransfer()" class="accent" style="background:var(--success)">‚úÖ Autorizar y Guardar</button>
        </div>
    </div>
</div>

<div class="container" id="mainContainer" style="display:none;">
    <div class="header">
        <div class="brand">
            <h1>Saint Aubin <span>International</span></h1>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="syncData(true)" class="primary">üîÑ Actualizar</button>
            <button onclick="logout()" style="background:#BDC3C7; color:#555;">üîí Salir</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>Tendencia Mensual (Presupuesto vs Ejecutado)</h2>
            <div style="height: 250px; position: relative;">
                <canvas id="budgetChart"></canvas>
            </div>
        </div>

        <div class="kpi-container">
            <div class="kpi-card"><small>Presupuesto Total</small><div class="kpi-val" id="kTotal">$0</div></div>
            <div class="kpi-card"><small>Disponible Real</small><div class="kpi-val" id="kAvail" style="color:var(--success)">$0</div></div>
            <div class="kpi-card"><small>% Ejecuci√≥n</small><div class="kpi-val" id="kPerc" style="color:var(--accent)">0%</div></div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>Registrar Nuevo Gasto</h2>
            <form onsubmit="tryAddExpense(event)">
                <div style="margin-bottom:5px;">
                    <label>Solicitante</label>
                    <select id="uName" required>
                        <option value="JIAT" selected>JIAT</option>
                        <option value="MBR">MBR</option>
                    </select>
                </div>
                
                <label>Rubro Presupuestal</label>
                <select id="selCode" required><option>Cargando c√≥digos...</option></select>
                
                <label>Concepto / Referencia</label>
                <input type="text" id="ref" placeholder="Ej: Factura 123 - Compra Insumos" required>
                
                <div style="display:flex; gap:15px;">
                    <div style="flex:1">
                        <label>Monto ($)</label>
                        <input type="text" id="amtDisplay" placeholder="0" required oninput="formatCurrencyInput(this)" style="font-weight:bold; color:var(--primary);">
                    </div>
                    <div style="flex:1">
                        <label>Fecha</label>
                        <input type="date" id="date" required>
                    </div>
                </div>
                <button type="submit" id="btnSave" class="accent">Validar Disponibilidad</button>
            </form>
        </div>

        <div class="card">
            <h2>√öltimos Gastos</h2>
            <div class="table-wrap" style="max-height:380px">
                <table id="histTable">
                    <thead><tr><th>Fecha</th><th>C√≥d</th><th>Solicitante</th><th>Concepto</th><th>Monto</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>
            Ejecuci√≥n Presupuestal Mensual
            <button onclick="downloadExcel()" class="success">üì• Exportar Excel</button>
        </h2>
        <div class="table-wrap">
            <table id="mainTable">
                <thead><tr><th>C√≥d</th><th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th><th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th><th>Total</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="grid-transfer">
        <div class="card transfer-zone">
            <h2>M√≥dulo de Traslados</h2>
            <form onsubmit="handleTransfer(event)">
                <label>Rubro a Modificar</label>
                <select id="selCodeTransfer" required><option>Cargando...</option></select>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Origen (Saca)</label>
                        <select id="monthSource" required></select>
                    </div>
                    <div style="flex:1">
                        <label>Destino (Pone)</label>
                        <select id="monthTarget" required></select>
                    </div>
                </div>

                <label>Valor a Trasladar ($)</label>
                <input type="text" id="amtTransfer" placeholder="0" required oninput="formatCurrencyInput(this)" style="color:var(--warning); font-weight:bold;">

                <button type="submit" class="warning">Autorizar Traslado</button>
            </form>
        </div>

        <div class="card transfer-zone">
            <h2>Bit√°cora de Auditor√≠a</h2>
            <div class="table-wrap" style="max-height:300px">
                <table id="transfersTable">
                    <thead><tr><th>Fecha</th><th>C√≥digo</th><th>Movimiento</th><th>Valor</th><th>Autoriz√≥</th></tr></thead>
                    <tbody><tr><td colspan="5" style="text-align:center; color:#999;">Cargando...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ==================================================
    // ‚ö†Ô∏è PEGA TU URL DE SHEETDB AQU√ç ‚ö†Ô∏è
    const API_URL = "https://sheetdb.io/api/v1/sw4ed7qqbxl4k";
    // ==================================================

    let budget = [], expenses = [], transfers = [];
    let DETECTED_HEADERS = new Array(12).fill(null); 
    let myChart = null;
    
    const MONTH_POSSIBILITIES = [
        ["ENERO","Enero","ENE","JAN","January"], ["FEBRERO","Febrero","FEB","February"], ["MARZO","Marzo","MAR","March"],
        ["ABRIL","Abril","ABR","APR","April"], ["MAYO","Mayo","MAY","May"], ["JUNIO","Junio","JUN","June"],
        ["JULIO","Julio","JUL","July"], ["AGOSTO","Agosto","AGO","AUG","August"], ["SEPTIEMBRE","Septiembre","SEP","September"],
        ["OCTUBRE","Octubre","OCT","October"], ["NOVIEMBRE","Noviembre","NOV","November"], ["DICIEMBRE","Diciembre","DIC","December"]
    ];
    const MONTH_LABELS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    let pendingExpense = null;

    function unlockApp() {
        document.getElementById('mainContainer').style.display = 'block';
        const u = localStorage.getItem('u');
        if(u && (u === "JIAT" || u === "MBR")) {
             document.getElementById('uName').value = u;
        }
        document.getElementById('date').valueAsDate = new Date();
        populateMonthSelects();
        syncData(true);
    }

    function populateMonthSelects() {
        const s1 = document.getElementById('monthSource');
        const s2 = document.getElementById('monthTarget');
        s1.innerHTML = '<option value="">Sel. Mes</option>';
        s2.innerHTML = '<option value="">Sel. Mes</option>';
        MONTH_LABELS.forEach((m, i) => {
            const op1 = document.createElement('option'); op1.value = i; op1.text = m;
            const op2 = document.createElement('option'); op2.value = i; op2.text = m;
            s1.appendChild(op1); s2.appendChild(op2);
        });
    }

    // --- UTILIDADES ---
    function formatCurrencyInput(input) {
        let val = input.value.replace(/\D/g, '');
        if (val === "") { input.value = ""; return; }
        input.value = new Intl.NumberFormat('es-CO').format(parseInt(val));
    }
    function getAmountValue(id) {
        return parseFloat(document.getElementById(id).value.replace(/\./g, '')) || 0;
    }
    function getSmartValue(obj, keys) {
        if(!obj) return undefined;
        const objKeys = Object.keys(obj);
        for(const k of keys) {
            const found = objKeys.find(ok => ok.trim().toUpperCase() === k.toUpperCase());
            if(found) return obj[found];
        }
        return undefined;
    }
    function detectMonthHeaders(sampleRow) {
        if(!sampleRow) return;
        const keys = Object.keys(sampleRow);
        MONTH_POSSIBILITIES.forEach((possibles, idx) => {
            const found = keys.find(k => possibles.includes(k.trim().toUpperCase()));
            if(found) DETECTED_HEADERS[idx] = found;
        });
    }

    // --- EXPORTAR A EXCEL ---
    function downloadExcel() {
        let csv = "Codigo,Ene,Feb,Mar,Abr,May,Jun,Jul,Ago,Sep,Oct,Nov,Dic,Total\n";
        budget.forEach(l => {
            const code = getSmartValue(l, ["CODIGO","Codigo"]);
            if(!code) return;
            let row = [code];
            let total = 0;
            for(let i=0; i<12; i++) {
                let rawBud = getSmartValue(l, MONTH_POSSIBILITIES[i]) || "0";
                if(typeof rawBud === 'string') rawBud = rawBud.replace(/\./g,'').replace(/,/g,'.');
                let bud = parseFloat(rawBud) || 0;
                let spent = 0;
                expenses.forEach(x => {
                    const c = getSmartValue(x, ["code","Code","CODIGO"]);
                    const d = getSmartValue(x, ["date","Date","Fecha"]);
                    const a = parseFloat(getSmartValue(x, ["amount","Amount","Monto","MONTO"])) || 0;
                    if (c == code && d && (parseInt(d.split('-')[1])-1) == i) spent += a;
                });
                row.push(bud - spent); 
                total += (bud - spent);
            }
            row.push(total);
            csv += row.join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "Ejecucion_Presupuestal.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- GR√ÅFICA ---
    function updateChart() {
        // Seguridad: si Chart no carga, no fallamos
        if (typeof Chart === 'undefined') return; 
        
        const ctx = document.getElementById('budgetChart').getContext('2d');
        let dataBudget = new Array(12).fill(0);
        let dataSpent = new Array(12).fill(0);

        budget.forEach(b => {
            for(let i=0; i<12; i++) {
                let rawBud = getSmartValue(b, MONTH_POSSIBILITIES[i]) || "0";
                if(typeof rawBud === 'string') rawBud = rawBud.replace(/\./g,'').replace(/,/g,'.');
                dataBudget[i] += (parseFloat(rawBud) || 0);
            }
        });

        expenses.forEach(x => {
            const d = getSmartValue(x, ["date","Date","Fecha","FECHA"]);
            if(d) {
                const mIdx = parseInt(d.split('-')[1]) - 1;
                const amt = parseFloat(getSmartValue(x, ["amount","Amount","Monto","MONTO"])) || 0;
                if(mIdx >= 0 && mIdx < 12) dataSpent[mIdx] += amt;
            }
        });

        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: MONTH_LABELS,
                datasets: [
                    { label: 'Presupuesto', data: dataBudget, backgroundColor: '#002B5C', borderRadius: 4 },
                    { label: 'Ejecutado', data: dataSpent, backgroundColor: '#00A3E0', borderRadius: 4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    // --- SINCRONIZACI√ìN ---
    async function syncData(showLoaderUI = false) {
        if(showLoaderUI) {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loadMsg').innerText = "Sincronizando...";
        }
        
        let attempts = 0;
        let success = false;
        
        while(attempts < 2 && !success) { 
            attempts++;
            try {
                const ts = Date.now();
                const resB = await fetch(`${API_URL}?sheet=Presupuesto&t=${ts}`);
                budget = await resB.json();
                
                if((!budget || budget.length === 0) && attempts === 1) throw new Error("Cold Start");
                if(budget.length > 0) detectMonthHeaders(budget[0]);

                const resE = await fetch(`${API_URL}?sheet=Gastos&t=${ts}`);
                expenses = await resE.json();

                const resT = await fetch(`${API_URL}?sheet=Traslados&t=${ts}`);
                transfers = await resT.json();

                renderUI();
                updateChart();
                success = true;
            } catch (e) {
                console.warn("Intento fallido:", e);
                if(attempts === 1) await new Promise(r => setTimeout(r, 1500)); 
            }
        }
        
        if(!success && showLoaderUI) alert("‚ö†Ô∏è No se pudieron cargar los datos.");
        if(showLoaderUI) document.getElementById('loader').style.display = 'none';
    }

    // --- L√ìGICA DE NEGOCIO ---
    async function tryAddExpense(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSave');
        btn.disabled = true; btn.innerText = "Verificando...";
        
        await syncData(false); 

        const code = document.getElementById('selCode').value;
        const amount = getAmountValue('amtDisplay');
        const dateStr = document.getElementById('date').value;
        const ref = document.getElementById('ref').value;
        const monthIdx = parseInt(dateStr.split('-')[1]) - 1;

        const line = budget.find(b => getSmartValue(b, ["CODIGO","Codigo","Code"]) == code);
        
        if (!line) {
            alert("C√≥digo no encontrado");
            btn.disabled = false; btn.innerText = "Validar y Guardar";
            return;
        }

        const header = DETECTED_HEADERS[monthIdx];
        let rawBud = header ? line[header] : "0";
        if(typeof rawBud === 'string') rawBud = rawBud.replace(/\./g,'').replace(/,/g,'.');
        const budgetMonth = parseFloat(rawBud) || 0;

        let spentMonth = 0;
        expenses.forEach(x => {
            const xCode = getSmartValue(x, ["code", "Code", "Codigo", "CODIGO"]);
            const xDate = getSmartValue(x, ["date", "Date", "Fecha", "FECHA"]);
            const xAmt = parseFloat(getSmartValue(x, ["amount", "Amount", "Monto", "MONTO"])) || 0;
            if (xCode == code && xDate && (parseInt(xDate.split('-')[1])-1) == monthIdx) spentMonth += xAmt;
        });

        if (amount > (budgetMonth - spentMonth)) {
            const missing = amount - (budgetMonth - spentMonth);
            alert(`‚õî SALDO INSUFICIENTE\n\nRubro: ${code}\nMes: ${MONTH_LABELS[monthIdx]}\nDisponible: ${fmt(budgetMonth - spentMonth)}\nFaltan: ${fmt(missing)}\n\nPor favor realiza un traslado en el M√≥dulo de Traslados (abajo).`);
            btn.disabled = false; btn.innerText = "Validar y Guardar";
        } else {
            saveExpense(code, ref, amount, dateStr);
        }
    }

    async function handleTransfer(e) {
        e.preventDefault();
        const code = document.getElementById('selCodeTransfer').value;
        const sourceIdx = parseInt(document.getElementById('monthSource').value);
        const targetIdx = parseInt(document.getElementById('monthTarget').value);
        const amount = getAmountValue('amtTransfer');
        const user = document.getElementById('uName').value;

        if(isNaN(sourceIdx) || isNaN(targetIdx)) return alert("Selecciona meses v√°lidos");
        if(sourceIdx === targetIdx) return alert("Origen y Destino deben ser diferentes");
        if(amount <= 0) return alert("Monto inv√°lido");

        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loadMsg').innerText = "Verificando fondos...";

        await syncData(false);
        const line = budget.find(b => getSmartValue(b, ["CODIGO","Codigo","Code"]) == code);
        
        const colSource = DETECTED_HEADERS[sourceIdx];
        const colTarget = DETECTED_HEADERS[targetIdx];

        if(!colSource || !colTarget) { document.getElementById('loader').style.display = 'none'; return alert("Error DB"); }

        let rawBud = line[colSource] || "0";
        if(typeof rawBud === 'string') rawBud = rawBud.replace(/\./g,'').replace(/,/g,'.');
        const budgetSource = parseFloat(rawBud) || 0;
        
        let spentSource = 0;
        expenses.forEach(x => {
            const xCode = getSmartValue(x, ["code", "Code", "Codigo", "CODIGO"]);
            const xDate = getSmartValue(x, ["date", "Date", "Fecha", "FECHA"]);
            const xAmt = parseFloat(getSmartValue(x, ["amount", "Amount", "Monto", "MONTO"])) || 0;
            if (xCode == code && xDate && (parseInt(xDate.split('-')[1])-1) == sourceIdx) spentSource += xAmt;
        });

        if (amount > (budgetSource - spentSource)) {
            document.getElementById('loader').style.display = 'none';
            return alert(`‚õî Fondos insuficientes en ${MONTH_LABELS[sourceIdx]}.\nDisponible: ${fmt(budgetSource - spentSource)}`);
        }

        try {
            document.getElementById('loadMsg').innerText = "Aplicando traslado...";
            
            let valSource = parseFloat(String(line[colSource]).replace(/\./g,'').replace(/,/g,'.')) || 0;
            let valTarget = parseFloat(String(line[colTarget]).replace(/\./g,'').replace(/,/g,'.')) || 0;

            const updateData = {};
            updateData[colSource] = valSource - amount;
            updateData[colTarget] = valTarget + amount;
            
            const codeKey = Object.keys(line).find(k => k.toUpperCase() === "CODIGO") || "CODIGO";

            await fetch(`${API_URL}/${codeKey}/${encodeURIComponent(code)}?sheet=Presupuesto`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: updateData })
            });

            const logData = { "Fecha": new Date().toISOString().split('T')[0], "Codigo": code, "Origen": colSource, "Destino": colTarget, "Valor": amount, "Usuario": user };
            await fetch(`${API_URL}?sheet=Traslados`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [logData] })
            });
            
            alert("‚úÖ Traslado Exitoso");
            document.getElementById('amtTransfer').value = "";
            syncData(true);
        } catch (e) { alert("Error: " + e.message); document.getElementById('loader').style.display = 'none'; }
    }

    async function saveExpense(code, ref, amount, date) {
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loadMsg').innerText = "Guardando gasto...";
        
        const user = document.getElementById('uName').value;
        localStorage.setItem('u', user);

        const rowData = { "id": Date.now(), "code": code, "CODIGO": code, "ref": ref, "REFERENCIA": ref, "amount": amount, "MONTO": amount, "date": date, "FECHA": date, "user": user, "USUARIO": user };

        try {
            const res = await fetch(`${API_URL}?sheet=Gastos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [rowData] })
            });

            if (!res.ok) throw new Error("Error al guardar");

            await syncData(false);
            document.getElementById('ref').value = "";
            document.getElementById('amtDisplay').value = "";
            document.getElementById('loader').style.display = 'none';
            const btn = document.getElementById('btnSave');
            btn.disabled = false; btn.innerText = "Validar y Guardar";
            alert("‚úÖ Gasto registrado correctamente.");
        } catch(e) {
            document.getElementById('loader').style.display = 'none';
            const btn = document.getElementById('btnSave');
            btn.disabled = false; btn.innerText = "Validar y Guardar";
            alert("Error: " + e.message);
        }
    }

    async function delExp(id) {
        if(!confirm("¬øBorrar este registro?")) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            await fetch(`${API_URL}/id/${id}?sheet=Gastos`, { method: 'DELETE' });
            await syncData(false);
        } catch(e) { alert("Error: " + e.message); }
        document.getElementById('loader').style.display = 'none';
    }

    function renderUI() {
        const sel1 = document.getElementById('selCode');
        const sel2 = document.getElementById('selCodeTransfer');
        const c1 = sel1.value; const c2 = sel2.value;
        const opts = '<option value="">-- Seleccionar Rubro --</option>';
        sel1.innerHTML = opts; sel2.innerHTML = opts;
        budget.forEach(b => {
            const code = getSmartValue(b, ["CODIGO","Codigo"]);
            const desc = getSmartValue(b, ["DESCRIPCION","Descripcion"]) || "";
            if(code) {
                const txt = `${code} - ${desc.substring(0,35)}`;
                const o1 = document.createElement('option'); o1.value = code; o1.text = txt;
                const o2 = document.createElement('option'); o2.value = code; o2.text = txt;
                sel1.appendChild(o1); sel2.appendChild(o2);
            }
        });
        if(c1) sel1.value = c1; if(c2) sel2.value = c2;

        const expMap = {};
        let tSpent = 0;
        expenses.forEach(x => {
            const d = getSmartValue(x, ["date","Date","Fecha","FECHA"]);
            if(!d) return;
            const p = d.split('-');
            const m = parseInt(p[1])-1;
            const c = getSmartValue(x, ["code","Code","Codigo","CODIGO"]);
            const val = parseFloat(getSmartValue(x, ["amount","Amount","Monto","MONTO"])) || 0;
            expMap[`${c}-${m}`] = (expMap[`${c}-${m}`]||0) + val;
            tSpent += val;
        });

        const tb = document.querySelector('#mainTable tbody');
        tb.innerHTML = '';
        let tBud = 0;

        budget.forEach(l => {
            const code = getSmartValue(l, ["CODIGO","Codigo"]);
            if(!code) return;
            const tr = document.createElement('tr');
            let h = `<td><b>${code}</b></td>`;
            let rowSum = 0;
            for(let i=0; i<12; i++) {
                let rawVal = getSmartValue(l, MONTH_POSSIBILITIES[i]) || "0";
                if(typeof rawVal === 'string') rawVal = rawVal.replace(/\./g, '').replace(/,/g, '.');
                let b = Number(rawVal) || 0;
                rowSum += b;
                let s = expMap[`${code}-${i}`]||0;
                let color = s > b ? '#e74c3c' : (s > 0 ? '#27ae60' : '#95a5a6');
                h += `<td>${b?fmt(b):'-'}<br><span style="color:${color};font-weight:bold;font-size:0.85em">${s?fmt(s):''}</span></td>`;
            }
            let total = Number(getSmartValue(l, ["TOTAL","Total"])||0);
            if(total===0) total = rowSum;
            tBud += total;
            h += `<td><b>${fmt(total)}</b></td>`;
            tr.innerHTML = h;
            tb.appendChild(tr);
        });

        document.getElementById('kTotal').innerText = fmt(tBud);
        document.getElementById('kAvail').innerText = fmt(tBud-tSpent);
        document.getElementById('kPerc').innerText = tBud>0 ? ((tSpent/tBud)*100).toFixed(1)+"%" : "0%";

        const th = document.querySelector('#histTable tbody');
        th.innerHTML = '';
        [...expenses].sort((a,b)=>getSmartValue(b,["id"])-getSmartValue(a,["id"])).forEach(x => {
            const r = document.createElement('tr');
            const d = getSmartValue(x, ["date","Date","Fecha"]);
            const u = getSmartValue(x, ["user","User","Usuario"]) || "-";
            const rf = getSmartValue(x, ["ref","Ref","Referencia"]);
            const cod = getSmartValue(x, ["code","Code","CODIGO"]); 
            const am = getSmartValue(x, ["amount","Amount","Monto"]);
            const id = getSmartValue(x, ["id","ID"]);
            r.innerHTML = `<td>${d}</td><td>${cod}</td><td>${u}</td><td>${rf}</td><td style="font-weight:bold">${fmt(am)}</td><td style="text-align:right"><button class="danger" onclick="delExp(${id})">√ó</button></td>`;
            th.appendChild(r);
        });

        const tt = document.querySelector('#transfersTable tbody');
        tt.innerHTML = '';
        if(!transfers || transfers.length === 0) {
            tt.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">Sin movimientos</td></tr>';
        } else {
            [...transfers].reverse().slice(0,10).forEach(t => {
                const r = document.createElement('tr');
                const date = getSmartValue(t, ["Fecha","FECHA"]);
                const cod = getSmartValue(t, ["Codigo","CODIGO"]);
                const ori = getSmartValue(t, ["Origen","ORIGEN"]);
                const dest = getSmartValue(t, ["Destino","DESTINO"]);
                const val = getSmartValue(t, ["Valor","VALOR"]);
                const usr = getSmartValue(t, ["Usuario","USUARIO"]) || "-";
                r.innerHTML = `<td>${date}</td><td>${cod}</td><td><span class="badge-transfer">${ori} ‚ûî ${dest}</span></td><td style="font-weight:bold">${fmt(val)}</td><td>${usr}</td>`;
                tt.appendChild(r);
            });
        }
    }

    function fmt(n) { return new Intl.NumberFormat('es-CO', {maximumFractionDigits:0}).format(n); }
</script>
</body>
</html>
