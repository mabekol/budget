<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Presupuestal G&C</title>
    <style>
        /* ESTILOS G&C */
        :root { --primary: #2F4F4F; --accent: #48C9B0; --bg: #EBF5F3; --white: #fff; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; font-size:14px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .card { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width:800px){ .grid { grid-template-columns: 1fr; } }
        
        input, select { padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; font-size: 1em; }
        label { font-weight: bold; color: var(--primary); display: block; margin-bottom: 5px; }
        
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; background: var(--primary); transition: 0.2s; }
        button.accent { background: var(--accent); color: #004d40; width: 100%; }
        button.danger { background: var(--danger); padding: 5px 10px; font-size: 0.8em; }
        button:disabled { background: #ccc; cursor: wait; }
        
        .kpi-box { display: flex; justify-content: space-between; text-align: center; }
        .kpi-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background: var(--primary); color: white; padding: 8px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .table-wrap { overflow-x: auto; }
        
        /* LOADER & MODAL */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; display: none; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-top: 5px solid var(--danger); }
        .modal h3 { color: var(--danger); margin-top: 0; }
        .transfer-box { background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee; margin-top: 15px; }
    </style>
</head>
<body>

<div id="loader"><h2>üîÑ Cargando...</h2><p id="loadMsg">Iniciando sistema...</p></div>

<div id="alertModal" class="modal-overlay">
    <div class="modal">
        <h3>‚ö†Ô∏è Saldo Insuficiente</h3>
        <p>No tienes fondos en <b id="modalTargetMonth"></b>.</p>
        <p>Faltan: <b id="modalMissing" style="color:var(--danger)"></b></p>
        
        <div class="transfer-box">
            <label>Trasladar fondos desde:</label>
            <select id="modalSourceMonth"></select>
            <small style="color:#666">Meses con saldo disponible.</small>
        </div>
        
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
            <button onclick="closeModal()" style="background:#ccc; color:#333">Cancelar</button>
            <button onclick="executeTransfer()" class="accent">‚úÖ Autorizar Traslado</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>G&C <span style="color:var(--accent)">SOLUTIONS</span></h1>
        <button onclick="syncData(true)">üîÑ Forzar Actualizaci√≥n</button>
    </div>

    <div class="card kpi-box">
        <div><small>PRESUPUESTO</small><div class="kpi-val" id="kTotal">$0</div></div>
        <div><small>DISPONIBLE</small><div class="kpi-val" id="kAvail">$0</div></div>
        <div><small>EJECUCI√ìN</small><div class="kpi-val" id="kPerc">0%</div></div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>Registrar Gasto</h2>
            <form onsubmit="tryAddExpense(event)">
                <label>C√≥digo</label><select id="selCode" required><option>Cargando...</option></select>
                <label>Referencia</label><input type="text" id="ref" required>
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Monto</label><input type="text" id="amtDisplay" placeholder="$ 0" required oninput="formatCurrencyInput(this)"></div>
                    <div style="flex:1"><label>Fecha</label><input type="date" id="date" required></div>
                </div>
                <button type="submit" id="btnSave" class="accent">Validar y Guardar</button>
            </form>
        </div>

        <div class="card">
            <h2>√öltimos Movimientos (Gastos)</h2>
            <div class="table-wrap" style="max-height:300px">
                <table id="histTable"><thead><tr><th>Fecha</th><th>Ref</th><th>Monto</th><th></th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Matriz Mensual</h2>
        <div class="table-wrap">
            <table id="mainTable">
                <thead><tr><th>Cod</th><th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th><th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th><th>Total</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ==================================================
    // ‚ö†Ô∏è PEGA TU URL DE SHEETDB AQU√ç ‚ö†Ô∏è
    const API_URL = "https://sheetdb.io/api/v1/sw4ed7qqbxl4k";
    // ==================================================

    let budget = [], expenses = [];
    let DETECTED_HEADERS = new Array(12).fill(null); 
    
    const MONTH_POSSIBILITIES = [
        ["ENERO","Enero","ENE","JAN","January"], ["FEBRERO","Febrero","FEB","February"], ["MARZO","Marzo","MAR","March"],
        ["ABRIL","Abril","ABR","APR","April"], ["MAYO","Mayo","MAY","May"], ["JUNIO","Junio","JUN","June"],
        ["JULIO","Julio","JUL","July"], ["AGOSTO","Agosto","AGO","AUG","August"], ["SEPTIEMBRE","Septiembre","SEP","September"],
        ["OCTUBRE","Octubre","OCT","October"], ["NOVIEMBRE","Noviembre","NOV","November"], ["DICIEMBRE","Diciembre","DIC","December"]
    ];
    const MONTH_LABELS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    let pendingExpense = null;

    document.addEventListener('DOMContentLoaded', () => {
        const u = localStorage.getItem('u');
        if(u) document.getElementById('uName').value = u;
        document.getElementById('date').valueAsDate = new Date();
        
        // INICIO ROBUSTO: Intentar conectar varias veces si falla
        syncData(true); 
    });

    // --- UTILIDADES ---
    function formatCurrencyInput(input) {
        let val = input.value.replace(/\D/g, '');
        if (val === "") { input.value = ""; return; }
        input.value = new Intl.NumberFormat('es-CO').format(parseInt(val));
    }
    function getAmountValue() {
        return parseFloat(document.getElementById('amtDisplay').value.replace(/\./g, '')) || 0;
    }
    function getSmartValue(obj, keys) {
        if(!obj) return undefined;
        const objKeys = Object.keys(obj);
        for(const k of keys) {
            const found = objKeys.find(ok => ok.trim().toUpperCase() === k.toUpperCase());
            if(found) return obj[found];
        }
        return undefined;
    }
    function detectMonthHeaders(sampleRow) {
        if(!sampleRow) return;
        const keys = Object.keys(sampleRow);
        MONTH_POSSIBILITIES.forEach((possibles, idx) => {
            const found = keys.find(k => possibles.includes(k.trim().toUpperCase()));
            if(found) DETECTED_HEADERS[idx] = found;
        });
    }

    // --- SINCRONIZACI√ìN "AUTO-DESPERTAR" ---
    async function syncData(showLoaderUI = false) {
        if(showLoaderUI) document.getElementById('loader').style.display = 'flex';
        
        let attempts = 0;
        let success = false;
        const maxAttempts = 3; // Intentar√° 3 veces antes de rendirse

        while(attempts < maxAttempts && !success) {
            attempts++;
            if(showLoaderUI) document.getElementById('loadMsg').innerText = `Conectando (Intento ${attempts}/${maxAttempts})...`;
            
            try {
                // Timestamp para evitar cach√© viejo
                const ts = Date.now();
                const headers = { 'Cache-Control': 'no-cache' };

                const resB = await fetch(`${API_URL}?sheet=Presupuesto&t=${ts}`, { headers });
                const jsonB = await resB.json();
                
                // Si recibimos array vacio o error, lanzamos excepcion para reintentar
                if(!Array.isArray(jsonB) || jsonB.length === 0) throw new Error("Datos vac√≠os");

                budget = jsonB;
                detectMonthHeaders(budget[0]);

                const resE = await fetch(`${API_URL}?sheet=Gastos&t=${ts}`, { headers });
                expenses = await resE.json();

                success = true; // ¬°√âxito! Salimos del bucle
                renderUI();

            } catch (e) {
                console.warn(`Intento ${attempts} fallido: ${e.message}`);
                // Esperar 1.5 segundos antes de reintentar
                if(attempts < maxAttempts) await new Promise(r => setTimeout(r, 1500));
            }
        }

        if(!success && showLoaderUI) {
            alert("‚ö†Ô∏è El servidor est√° dormido o lento. Por favor presiona 'Actualizar' nuevamente.");
        }
        
        if(showLoaderUI) document.getElementById('loader').style.display = 'none';
    }

    // --- VALIDACI√ìN ---
    async function tryAddExpense(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSave');
        btn.disabled = true; btn.innerText = "Verificando...";
        
        await syncData(true); // Recarga obligatoria

        const code = document.getElementById('selCode').value;
        const amount = getAmountValue();
        const dateStr = document.getElementById('date').value;
        const ref = document.getElementById('ref').value;
        const monthIdx = parseInt(dateStr.split('-')[1]) - 1;

        const line = budget.find(b => getSmartValue(b, ["CODIGO","Codigo","Code"]) == code);
        
        if (!line) {
            alert("C√≥digo no encontrado");
            btn.disabled = false; btn.innerText = "Validar y Guardar";
            return;
        }

        const header = DETECTED_HEADERS[monthIdx];
        let rawBud = header ? line[header] : "0";
        if(typeof rawBud === 'string') rawBud = rawBud.replace(/\./g,'').replace(/,/g,'.');
        const budgetMonth = parseFloat(rawBud) || 0;

        let spentMonth = 0;
        expenses.forEach(x => {
            if (x.code == code && (parseInt(x.date.split('-')[1])-1) == monthIdx) {
                spentMonth += parseFloat(x.amount);
            }
        });

        if (amount > (budgetMonth - spentMonth)) {
            const missing = amount - (budgetMonth - spentMonth);
            pendingExpense = { 
                code, amount, date: dateStr, ref, monthIdx, missing,
                user: localStorage.getItem('u') || "WebUser"
            };
            openModal(line, monthIdx, pendingExpense.missing);
            btn.disabled = false; btn.innerText = "Validar y Guardar";
        } else {
            saveExpense(code, ref, amount, dateStr);
        }
    }

    function openModal(line, targetIdx, missing) {
        const select = document.getElementById('modalSourceMonth');
        document.getElementById('modalTargetMonth').innerText = MONTH_LABELS[targetIdx];
        document.getElementById('modalMissing').innerText = fmt(missing);
        select.innerHTML = '';
        
        DETECTED_HEADERS.forEach((header, idx) => {
            if (idx === targetIdx || !header) return;
            let rawBud = line[header] || "0";
            if(typeof rawBud === 'string') rawBud = rawBud.replace(/\./g,'').replace(/,/g,'.');
            const bud = parseFloat(rawBud) || 0;
            
            let spent = 0;
            const codeVal = getSmartValue(line, ["CODIGO"]);
            expenses.forEach(x => {
                if (x.code == codeVal && (parseInt(x.date.split('-')[1])-1) == idx) {
                    spent += parseFloat(x.amount);
                }
            });

            if ((bud - spent) >= missing) {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = `${MONTH_LABELS[idx]} (Disp: ${fmt(bud-spent)})`;
                select.appendChild(opt);
            }
        });

        if (select.options.length === 0) select.innerHTML = '<option>‚õî Sin fondos</option>';
        document.getElementById('alertModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('alertModal').style.display = 'none';
    }

    // --- TRASLADO ---
    async function executeTransfer() {
        if(!pendingExpense) return;
        
        const transferData = { ...pendingExpense };
        const sourceIdx = document.getElementById('modalSourceMonth').value;
        
        if(isNaN(sourceIdx)) return alert("Selecciona un mes");

        closeModal();
        pendingExpense = null;

        const colSource = DETECTED_HEADERS[sourceIdx];
        const colTarget = DETECTED_HEADERS[transferData.monthIdx];

        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loadMsg').innerText = "Registrando traslado...";

        try {
            const line = budget.find(b => getSmartValue(b, ["CODIGO"]) == transferData.code);
            let valSource = parseFloat(String(line[colSource]).replace(/\./g,'').replace(/,/g,'.')) || 0;
            let valTarget = parseFloat(String(line[colTarget]).replace(/\./g,'').replace(/,/g,'.')) || 0;

            const updateData = {};
            updateData[colSource] = valSource - transferData.missing;
            updateData[colTarget] = valTarget + transferData.missing;
            const codeKey = Object.keys(line).find(k => k.toUpperCase() === "CODIGO") || "CODIGO";

            await fetch(`${API_URL}/${codeKey}/${encodeURIComponent(transferData.code)}?sheet=Presupuesto`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: updateData })
            });

            const logData = {
                "Fecha": new Date().toISOString().split('T')[0],
                "Codigo": transferData.code,
                "Origen": colSource,
                "Destino": colTarget,
                "Valor": transferData.missing,
                "Usuario": transferData.user
            };
            await fetch(`${API_URL}?sheet=Traslados`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [logData] })
            });

            document.getElementById('loadMsg').innerText = "Guardando gasto final...";
            await saveExpense(transferData.code, transferData.ref, transferData.amount, transferData.date, false, transferData.user);
            
            alert("‚úÖ Operaci√≥n Exitosa.");
            syncData(true);

        } catch (e) {
            alert("Error: " + e.message);
            document.getElementById('loader').style.display = 'none';
        }
    }

    // --- GUARDAR GASTO ---
    async function saveExpense(code, ref, amount, date, hideLoader=true, explicitUser=null) {
        if(hideLoader) document.getElementById('loader').style.display = 'flex';
        
        const user = explicitUser || document.getElementById('uName').value || "WebUser";
        localStorage.setItem('u', user);

        const rowData = {
            "id": Date.now(),
            "code": code, "CODIGO": code, "Codigo": code,
            "ref": ref, "REFERENCIA": ref, "Referencia": ref,
            "amount": amount, "MONTO": amount, "Monto": amount,
            "date": date, "FECHA": date, "Fecha": date,
            "user": user, "USUARIO": user, "Usuario": user
        };

        try {
            const res = await fetch(`${API_URL}?sheet=Gastos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [rowData] })
            });

            if (!res.ok) throw new Error("Error al guardar");

            if(hideLoader) {
                await syncData(false);
                document.getElementById('ref').value = "";
                document.getElementById('amtDisplay').value = "";
                document.getElementById('loader').style.display = 'none';
                
                const btn = document.getElementById('btnSave');
                btn.disabled = false; btn.innerText = "Validar y Guardar";

                alert("‚úÖ Guardado Correctamente");
            }
        } catch(e) {
            document.getElementById('loader').style.display = 'none';
            const btn = document.getElementById('btnSave');
            btn.disabled = false; btn.innerText = "Validar y Guardar";
            if(hideLoader) alert("Error: " + e.message);
            else throw e;
        }
    }

    async function delExp(id) {
        if(!confirm("¬øBorrar?")) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            await fetch(`${API_URL}/id/${id}?sheet=Gastos`, { method: 'DELETE' });
            await syncData(false);
        } catch(e) { alert("Error: " + e.message); }
        document.getElementById('loader').style.display = 'none';
    }

    function renderUI() {
        const sel = document.getElementById('selCode');
        const cur = sel.value;
        sel.innerHTML = '<option value="">-- Seleccionar --</option>';
        budget.forEach(b => {
            const code = getSmartValue(b, ["CODIGO","Codigo"]);
            const desc = getSmartValue(b, ["DESCRIPCION","Descripcion"]) || "";
            if(code) {
                const o = document.createElement('option');
                o.value = code;
                o.text = `${code} - ${desc.substring(0,30)}`;
                sel.appendChild(o);
            }
        });
        if(cur) sel.value = cur;

        const expMap = {};
        let tSpent = 0;
        expenses.forEach(x => {
            if(!x.date) return;
            const p = x.date.split('-');
            const m = parseInt(p[1])-1;
            const k = `${x.code}-${m}`;
            expMap[k] = (expMap[k]||0) + Number(x.amount);
            tSpent += Number(x.amount);
        });

        const tb = document.querySelector('#mainTable tbody');
        tb.innerHTML = '';
        let tBud = 0;

        budget.forEach(l => {
            const code = getSmartValue(l, ["CODIGO","Codigo"]);
            if(!code) return;
            
            const tr = document.createElement('tr');
            let h = `<td><b>${code}</b></td>`;
            let rowSum = 0;
            
            for(let i=0; i<12; i++) {
                const header = DETECTED_HEADERS[i];
                let rawVal = header ? l[header] : "0";
                if(typeof rawVal === 'string') rawVal = rawVal.replace(/\./g, '').replace(/,/g, '.');
                let b = Number(rawVal) || 0;
                rowSum += b;
                
                let s = expMap[`${code}-${i}`]||0;
                let color = s > b ? 'red' : (s > 0 ? '#27ae60' : '#ccc');
                h += `<td>${b?fmt(b):'-'}<br><span style="color:${color};font-weight:bold;font-size:0.85em">${s?fmt(s):''}</span></td>`;
            }
            let total = Number(l.TOTAL || l.Total || 0);
            if(total===0) total = rowSum;
            tBud += total;
            h += `<td><b>${fmt(total)}</b></td>`;
            tr.innerHTML = h;
            tb.appendChild(tr);
        });

        document.getElementById('kTotal').innerText = fmt(tBud);
        document.getElementById('kAvail').innerText = fmt(tBud-tSpent);
        document.getElementById('kPerc').innerText = tBud>0 ? ((tSpent/tBud)*100).toFixed(1)+"%" : "0%";

        const th = document.querySelector('#histTable tbody');
        th.innerHTML = '';
        [...expenses].sort((a,b)=>b.id-a.id).slice(0,10).forEach(x => {
            const r = document.createElement('tr');
            r.innerHTML = `<td>${x.date}</td><td>${x.ref}</td><td class="money">${fmt(x.amount)}</td><td><button class="danger" onclick="delExp(${x.id})">x</button></td>`;
            th.appendChild(r);
        });
    }

    function fmt(n) { return new Intl.NumberFormat('es-CO', {maximumFractionDigits:0}).format(n); }
</script>
