<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Presupuestal</title>
    <style>
        :root { --primary: #2F4F4F; --accent: #48C9B0; --bg: #EBF5F3; --white: #fff; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; font-size:14px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: var(--white); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width:800px){ .grid { grid-template-columns: 1fr; } }
        
        input, select { padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        label { font-weight: bold; color: var(--primary); display: block; margin-bottom: 5px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; background: var(--primary); transition: 0.2s; }
        button.accent { background: var(--accent); color: #004d40; width: 100%; }
        button.danger { background: var(--danger); padding: 5px 10px; font-size: 0.8em; }
        
        .kpi-box { display: flex; justify-content: space-between; text-align: center; }
        .kpi-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { background: var(--primary); color: white; padding: 8px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .table-wrap { overflow-x: auto; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; }
        .debug-bar { background: #fff3cd; color: #856404; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-family: monospace; display:none; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div id="loader">
    <h2>ðŸ”„ Cargando...</h2>
    <p id="loaderStatus">Conectando con SheetDB...</p>
</div>

<div class="container">
    <div id="debugInfo" class="debug-bar"></div>

    <div class="header">
        <h1>G&C <span style="color:var(--accent)">SOLUTIONS</span></h1>
        <button onclick="window.location.reload()">Recargar</button>
    </div>

    <div class="card kpi-box">
        <div><small>PRESUPUESTO</small><div class="kpi-val" id="kTotal">$0</div></div>
        <div><small>DISPONIBLE</small><div class="kpi-val" id="kAvail">$0</div></div>
        <div><small>EJECUCIÃ“N</small><div class="kpi-val" id="kPerc">0%</div></div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>Registrar Gasto</h2>
            <form onsubmit="addExpense(event)">
                <label>CÃ³digo</label><select id="selCode" required><option>Esperando datos...</option></select>
                <label>Referencia</label><input type="text" id="ref" required>
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Monto</label><input type="number" id="amt" required></div>
                    <div style="flex:1"><label>Fecha</label><input type="date" id="date" required></div>
                </div>
                <button type="submit" class="accent">Guardar</button>
            </form>
        </div>

        <div class="card">
            <h2>Ãšltimos Movimientos</h2>
            <div class="table-wrap" style="max-height:300px">
                <table id="histTable"><thead><tr><th>Fecha</th><th>Ref</th><th>Monto</th><th></th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Matriz Mensual</h2>
        <div class="table-wrap">
            <table id="mainTable">
                <thead><tr><th>Cod</th><th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th><th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th><th>Total</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ==================================================
    // âš ï¸ PEGA TU URL DE SHEETDB AQUÃ âš ï¸
    // Ejemplo: https://sheetdb.io/api/v1/sw4ed7qqbxl4k
    let API_URL = "https://sheetdb.io/api/v1/sw4ed7qqbxl4k";
    // ==================================================

    // --- AUTOCORRECCIÃ“N DE URL ---
    // Si por error pegaste la URL con ?sheet=... el cÃ³digo lo arregla solo
    if (API_URL.includes("?")) {
        API_URL = API_URL.split("?")[0];
        console.warn("URL corregida automÃ¡ticamente");
    }

    let budget = [], expenses = [];

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('date').valueAsDate = new Date();
        syncData();
    });

    async function syncData() {
        const loader = document.getElementById('loader');
        const status = document.getElementById('loaderStatus');
        loader.style.display = 'flex';
        
        try {
            // 1. LEER PRESUPUESTO
            status.innerText = "Leyendo Presupuesto...";
            const resB = await fetch(`${API_URL}?sheet=Presupuesto`);
            const jsonB = await resB.json();
            
            if (jsonB.error) throw new Error("Error SheetDB: " + jsonB.error);
            budget = Array.isArray(jsonB) ? jsonB : [];

            // 2. LEER GASTOS
            status.innerText = "Leyendo Gastos...";
            const resE = await fetch(`${API_URL}?sheet=Gastos`);
            const jsonE = await resE.json();
            expenses = Array.isArray(jsonE) ? jsonE : [];

            renderUI(); // Pintar la pantalla
            
        } catch (e) {
            console.error(e);
            showDebug("Error CrÃ­tico: " + e.message + ". Revisa la consola.");
        }
        loader.style.display = 'none';
    }

    async function addExpense(e) {
        e.preventDefault();
        document.getElementById('loader').style.display = 'flex';

        const data = {
            id: Date.now(),
            code: document.getElementById('selCode').value,
            ref: document.getElementById('ref').value,
            amount: document.getElementById('amt').value,
            date: document.getElementById('date').value
        };

        try {
            await fetch(`${API_URL}?sheet=Gastos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: data })
            });
            
            expenses.push(data);
            renderUI();
            document.getElementById('ref').value = "";
            document.getElementById('amt').value = "";
            alert("âœ… Guardado");
        } catch (e) { alert("Error al guardar: " + e.message); }
        document.getElementById('loader').style.display = 'none';
    }

    async function delExp(id) {
        if(!confirm("Â¿Borrar?")) return;
        document.getElementById('loader').style.display = 'flex';
        try {
            await fetch(`${API_URL}/id/${id}?sheet=Gastos`, { method: 'DELETE' });
            expenses = expenses.filter(x => x.id != id);
            renderUI();
        } catch(e) { alert("Error: " + e.message); }
        document.getElementById('loader').style.display = 'none';
    }

    // --- FUNCIÃ“N INTELIGENTE PARA ENCONTRAR DATOS ---
    // Busca "Codigo", "CODIGO", "codigo" automÃ¡ticamente
    function getVal(obj, keys) {
        if (!obj) return undefined;
        // Si pasamos una sola clave, la volvemos array
        if (!Array.isArray(keys)) keys = [keys];
        
        // Obtenemos todas las llaves reales del objeto que vino de SheetDB
        const objectKeys = Object.keys(obj);
        
        for (let k of keys) {
            // Buscamos ignorando mayÃºsculas/minÃºsculas
            const foundKey = objectKeys.find(ok => ok.toLowerCase() === k.toLowerCase());
            if (foundKey) return obj[foundKey];
        }
        return undefined;
    }

    function renderUI() {
        const sel = document.getElementById('selCode');
        sel.innerHTML = '<option value="">-- Seleccionar --</option>';
        
        if (budget.length === 0) {
            showDebug("Alerta: No se encontraron filas en la hoja 'Presupuesto'.");
            return;
        }

        // DIAGNÃ“STICO: Verificamos quÃ© columnas llegaron en la primera fila
        const firstRowKeys = Object.keys(budget[0]).join(", ");
        console.log("Columnas detectadas:", firstRowKeys);

        // Mapa de Gastos
        const expMap = {};
        let tSpent = 0;
        expenses.forEach(x => {
            if(!x.date) return;
            const p = x.date.split('-');
            const m = parseInt(p[1])-1;
            const k = `${getVal(x, ['code', 'codigo'])}-${m}`;
            expMap[k] = (expMap[k]||0) + Number(getVal(x, ['amount', 'monto']));
            tSpent += Number(getVal(x, ['amount', 'monto']));
        });

        // Matriz
        const tb = document.querySelector('#mainTable tbody');
        tb.innerHTML = '';
        let tBud = 0;
        
        // Nombres de meses posibles (EspaÃ±ol e InglÃ©s)
        const monthNames = [
            ["Ene","Enero","Jan","January"], ["Feb","Febrero","Feb","February"], ["Mar","Marzo","Mar","March"],
            ["Abr","Abril","Apr","April"], ["May","Mayo","May"], ["Jun","Junio","Jun","June"],
            ["Jul","Julio","Jul","July"], ["Ago","Agosto","Aug","August"], ["Sep","Septiembre","Sep","September"],
            ["Oct","Octubre","Oct","October"], ["Nov","Noviembre","Nov","November"], ["Dic","Diciembre","Dec","December"]
        ];

        budget.forEach(l => {
            // Usamos el buscador inteligente
            const code = getVal(l, ['codigo', 'code', 'cod']);
            const desc = getVal(l, ['descripcion', 'desc', 'description']) || "";
            
            if(!code) return;
            
            const total = Number(getVal(l, ['total', 'total aÃ±o', 'total_aÃ±o']) || 0);
            
            const tr = document.createElement('tr');
            let h = `<td><b>${code}</b></td>`;
            let rowSum = 0;

            for(let i=0; i<12; i++) {
                // Busca el mes probando todos los nombres posibles
                let valRaw = getVal(l, monthNames[i]);
                
                // Limpieza de nÃºmeros (quita puntos de miles)
                if(typeof valRaw === 'string') valRaw = valRaw.replace(/\./g, '').replace(/,/g, '.');
                
                let b = Number(valRaw) || 0;
                rowSum += b;

                let s = expMap[`${code}-${i}`]||0;
                h += `<td>${b?fmt(b):'-'}<br><span style="color:${s?'red':'#ccc'}">${s?fmt(s):''}</span></td>`;
            }
            
            // Si no hay columna total, usamos la suma
            let finalTotal = total > 0 ? total : rowSum;
            tBud += finalTotal;

            h += `<td><b>${fmt(finalTotal)}</b></td>`;
            tr.innerHTML = h;
            tb.appendChild(tr);

            // Llenar Select
            const o = document.createElement('option');
            o.value = code;
            o.text = `${code} - ${desc.substring(0,30)}`;
            sel.appendChild(o);
        });

        document.getElementById('kTotal').innerText = fmt(tBud);
        document.getElementById('kAvail').innerText = fmt(tBud-tSpent);
        document.getElementById('kPerc').innerText = tBud>0 ? ((tSpent/tBud)*100).toFixed(1)+"%" : "0%";

        // Historial
        const th = document.querySelector('#histTable tbody');
        th.innerHTML = '';
        [...expenses].sort((a,b)=>getVal(b, 'id') - getVal(a, 'id')).slice(0,10).forEach(x => {
            const r = document.createElement('tr');
            const id = getVal(x, 'id');
            r.innerHTML = `<td>${getVal(x, 'date')}</td><td>${getVal(x, 'ref')}</td><td class="money">${fmt(getVal(x, 'amount'))}</td><td><button class="danger" onclick="delExp(${id})">x</button></td>`;
            th.appendChild(r);
        });
    }

    function showDebug(msg) {
        const d = document.getElementById('debugInfo');
        d.style.display = 'block';
        d.innerText = msg;
    }

    function fmt(n) { return new Intl.NumberFormat('es-CO', {maximumFractionDigits:0}).format(n); }
</script>
</body>
</html>
