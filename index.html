<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G&C Solutions - Control Presupuestal</title>
    <style>
        /* ESTILOS */
        :root { --primary: #2F4F4F; --accent: #48C9B0; --bg: #EBF5F3; --text: #2C3E50; --white: #fff; --danger: #c0392b; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* HEADER */
        .brand-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .logo-text { font-size: 1.8rem; font-weight: 800; color: var(--accent); }
        .logo-sub { color: var(--primary); font-size: 1.8rem; font-weight: 800; }
        .app-title { font-size: 1.5rem; color: var(--primary); font-weight: 300; border-left: 3px solid var(--accent); padding-left: 15px; }

        /* CARDS */
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(72, 201, 176, 0.2); }
        h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--bg); padding-bottom: 10px; text-transform: uppercase; font-size: 1.1rem; }

        /* GRID */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media(max-width:900px){ .main-grid { grid-template-columns: 1fr; } }

        /* INPUTS & BTNS */
        label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--primary); }
        input, select { width: 100%; padding: 10px; border: 2px solid #eee; border-radius: 6px; background: #fafafa; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); color: #004d40; }
        .btn-danger { background: var(--danger); padding: 5px 10px; font-size: 0.8em; }

        /* KPIS */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi { background: white; padding: 20px; border-radius: 10px; text-align: center; border-bottom: 4px solid var(--accent); }
        .kpi-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }

        /* TABLES */
        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 100%; background: white; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .matrix th, .matrix td { text-align: right; border-right: 1px solid #f9f9f9; }
        .matrix th:first-child, .matrix td:first-child { text-align: left; position: sticky; left: 0; background: white; z-index: 5; border-right: 2px solid var(--accent); font-weight: bold; }
        .val-spent { color: var(--danger); font-weight: bold; font-size: 0.9em; display: block; border-top: 1px dotted #ccc; }
        .money { font-family: monospace; letter-spacing: -0.5px; }

        /* LOADER */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print { .no-print, .btn { display: none !important; } .card { border: none; shadow: none; } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><h3 style="color:var(--primary); margin-top:20px">Sincronizando...</h3></div>

<div class="container">
    <div class="brand-header">
        <div><span class="logo-text">G&C</span> <span class="logo-sub">SOLUTIONS</span></div>
        <div class="app-title">Control Presupuestal</div>
        <div style="margin-left:auto" class="no-print">
            <button onclick="syncData()" class="btn btn-primary">ðŸ”„ Actualizar</button>
        </div>
    </div>

    <div class="card no-print" id="configPanel" style="display:none;">
        <h3>ðŸ“‚ Inicializar Base de Datos</h3>
        <p>Sube el archivo <b>BUDGET CODIGOS.csv</b> para empezar.</p>
        <input type="file" id="csvFile" accept=".csv" style="max-width:300px;">
        <br><br>
        <button onclick="uploadBudgetCSV()" class="btn btn-accent">ðŸš€ Subir Presupuesto</button>
    </div>

    <div class="kpi-row">
        <div class="kpi"><small>PRESUPUESTO</small><div class="kpi-val money" id="kpiTotal">$0</div></div>
        <div class="kpi"><small>DISPONIBLE</small><div class="kpi-val money" id="kpiAvail" style="color:var(--success)">$0</div></div>
        <div class="kpi"><small>EJECUCIÃ“N</small><div class="kpi-val" id="kpiPerc">0%</div></div>
    </div>

    <div class="main-grid">
        <div class="card no-print">
            <h3>ðŸ’¸ Registrar Gasto</h3>
            <form onsubmit="addExpense(event)">
                <label>Usuario</label>
                <input type="text" id="userName" placeholder="Tu nombre" required>
                <label>CÃ³digo</label>
                <select id="selCode" required><option value="">-- Cargando... --</option></select>
                <label>Referencia / OC</label>
                <input type="text" id="ocRef" required>
                <div style="display:flex; gap:10px">
                    <div style="flex:1"><label>Monto</label><input type="number" id="ocAmount" required min="0"></div>
                    <div style="flex:1"><label>Fecha</label><input type="date" id="ocDate" required></div>
                </div>
                <br>
                <button type="submit" class="btn btn-accent" style="width:100%">ðŸ’¾ Guardar</button>
            </form>
        </div>

        <div class="card no-print">
            <h3>ðŸ•’ Historial</h3>
            <div class="table-wrap" style="max-height: 400px;">
                <table id="historyTable">
                    <thead><tr><th>Fecha</th><th>Ref</th><th>Monto</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ðŸ“… EjecuciÃ³n Mensual</h3>
        <input type="text" id="searchBox" placeholder="Buscar..." style="margin-bottom:10px;" onkeyup="filterTable(this.value)">
        <div class="table-wrap">
            <table id="matrixTable" class="matrix">
                <thead><tr><th>Cod</th><th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th><th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th><th>Total</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ============================================
    // âš ï¸ PEGA TU URL DE GOOGLE SCRIPT AQUÃ âš ï¸
    const API_URL = "https://script.google.com/macros/s/AKfycbyY6CLfqFmd-BRGMamuzyQ3lYB08Cd5UEeQHnmNPn6oms6j0IjJAKpkj2R_KZVaDUs/exec";
    // ============================================

    let budget = [];
    let expenses = [];

    document.addEventListener('DOMContentLoaded', () => {
        const u = localStorage.getItem('gc_user');
        if(u) document.getElementById('userName').value = u;
        document.getElementById('ocDate').valueAsDate = new Date();
        syncData();
    });

    // --- SINCRONIZACIÃ“N (VÃA GET - NO SE BLOQUEA) ---
    async function syncData() {
        showLoader(true);
        try {
            // 1. LEER PRESUPUESTO
            const resB = await fetch(API_URL + "?sheet=Presupuesto", { method: 'GET' });
            const dataB = await resB.json();
            budget = Array.isArray(dataB) ? dataB : [];

            // 2. LEER GASTOS
            const resE = await fetch(API_URL + "?sheet=Gastos", { method: 'GET' });
            const dataE = await resE.json();
            expenses = Array.isArray(dataE) ? dataE : [];

            renderUI();
        } catch (err) {
            console.error(err);
            // Si falla, es posible que sea la primera carga o bloqueo de red
            // No lanzamos alert invasivo, solo cambiamos el KPI
            if(budget.length === 0) document.getElementById('kpiTotal').innerText = "Offline";
        }
        showLoader(false);
    }

    // --- GUARDAR (VÃA POST - TEXT/PLAIN PARA EVITAR CORS) ---
    async function addExpense(e) {
        e.preventDefault();
        showLoader(true);
        const user = document.getElementById('userName').value;
        localStorage.setItem('gc_user', user);

        const data = {
            id: Date.now(),
            user: user,
            code: document.getElementById('selCode').value,
            ref: document.getElementById('ocRef').value,
            amount: parseFloat(document.getElementById('ocAmount').value),
            date: document.getElementById('ocDate').value
        };

        try {
            await fetch(API_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'addExpense', data: data })
            });
            
            expenses.push(data);
            renderUI();
            document.getElementById('ocRef').value = '';
            document.getElementById('ocAmount').value = '';
            alert("âœ… Guardado.");
        } catch (err) { alert("Error al guardar: " + err.message); }
        showLoader(false);
    }

    async function deleteExpense(id) {
        if(!confirm("Â¿Borrar?")) return;
        showLoader(true);
        try {
            await fetch(API_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'deleteExpense', id: id })
            });
            expenses = expenses.filter(e => e.id != id);
            renderUI();
        } catch(err) { alert("Error: " + err.message); }
        showLoader(false);
    }

    function uploadBudgetCSV() {
        const f = document.getElementById('csvFile').files[0];
        if(!f) return alert("Selecciona archivo");
        const r = new FileReader();
        r.readAsText(f, "ISO-8859-1");
        r.onload = async function(e) {
            showLoader(true);
            const lines = processCSV(e.target.result);
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'uploadBudget', data: lines })
                });
                alert("âœ… Presupuesto subido.");
                syncData();
            } catch(err) { alert("Error: " + err.message); }
            showLoader(false);
        }
    }

    // --- RENDERIZADO ---
    function renderUI() {
        document.getElementById('configPanel').style.display = budget.length ? 'none' : 'block';
        
        const sel = document.getElementById('selCode');
        const cv = sel.value;
        sel.innerHTML = '<option value="">-- Seleccionar --</option>';
        budget.forEach(b => {
            const o = document.createElement('option');
            o.value = b.codigo;
            o.text = `${b.codigo} - ${b.descripcion ? b.descripcion.substring(0,30) : ''}...`;
            sel.appendChild(o);
        });
        sel.value = cv;

        const expMap = {};
        let tSpent = 0;
        expenses.forEach(x => {
            if(!x.date) return;
            const p = x.date.split('-');
            if(p.length===3) {
                const m = parseInt(p[1])-1;
                const k = `${x.code}-${m}`;
                expMap[k] = (expMap[k]||0) + Number(x.amount);
                tSpent += Number(x.amount);
            }
        });

        const tb = document.querySelector('#matrixTable tbody');
        tb.innerHTML = '';
        let tBud = 0;
        budget.forEach(l => {
            tBud += Number(l.total||0);
            const tr = document.createElement('tr');
            let tds = `<td title="${l.descripcion}"><b>${l.codigo}</b><br><small>${l.descripcion?l.descripcion.substring(0,20):''}...</small></td>`;
            const ms = l.monthly || [];
            for(let i=0; i<12; i++) {
                const b = Number(ms[i]) || 0;
                const s = expMap[`${l.codigo}-${i}`] || 0;
                const bg = (new Date().getMonth()===i)?'style="background:#f0fbf7"':'';
                tds += `<td ${bg}>${b?fmt(b):'<span style="color:#eee">-</span>'}${s?`<span class="val-spent">${fmt(s)}</span>`:''}</td>`;
            }
            tds += `<td><b>${fmt(l.total)}</b></td>`;
            tr.innerHTML = tds;
            tb.appendChild(tr);
        });

        document.getElementById('kpiTotal').innerText = fmtMoney(tBud);
        document.getElementById('kpiAvail').innerText = fmtMoney(tBud - tSpent);
        document.getElementById('kpiPerc').innerText = tBud>0 ? ((tSpent/tBud)*100).toFixed(1)+"%" : "0%";

        const th = document.querySelector('#historyTable tbody');
        th.innerHTML = '';
        [...expenses].sort((a,b)=>b.id-a.id).slice(0,10).forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${x.date}</td><td><small>${x.user}</small><br>${x.ref}</td><td class="money">${fmtMoney(x.amount)}</td><td style="text-align:right"><button onclick="deleteExpense(${x.id})" class="btn-danger">Ã—</button></td>`;
            th.appendChild(tr);
        });
    }

    // UTILS
    function processCSV(t) {
        if(!t) return [];
        const l = t.split(/\r\n|\n|\r/);
        let s = ';';
        if(l[0] && (l[0].match(/,/g)||[]).length > (l[0].match(/;/g)||[]).length) s = ',';
        const res = [];
        for(let i=1; i<l.length; i++) {
            const r = l[i].split(s);
            if(r.length < 2) continue;
            const c = String(r[0]||"").replace(/"/g,'').trim();
            const d = String(r[1]||"").replace(/"/g,'').trim();
            const m = [];
            let tot = 0;
            for(let k=2; k<=13; k++) {
                let v = String(r[k]||"0").replace(/\./g,'').replace(/,/g,'.').replace(/[^0-9.-]/g,'');
                let n = parseFloat(v)||0;
                m.push(n); tot += n;
            }
            if(c) res.push({code:c, desc:d, monthly:m, total:tot});
        }
        return res;
    }

    function showLoader(s) { document.getElementById('loader').style.display = s?'flex':'none'; }
    function fmt(n) { return new Intl.NumberFormat('es-CO', {maximumFractionDigits:0}).format(n); }
    function fmtMoney(n) { return new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0}).format(n); }
    function filterTable(v) {
        v = v.toLowerCase();
        document.querySelectorAll('#matrixTable tbody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v)?'':'none');
    }
</script>
</body>
</html>



