<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G&C Solutions - Control Presupuestal Cloud</title>
    <style>
        /* === ESTILOS G&C SOLUTIONS === */
        :root { --primary: #2F4F4F; --accent: #48C9B0; --bg-body: #EBF5F3; --text-dark: #2C3E50; --success: #27ae60; --danger: #c0392b; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: var(--bg-body); color: var(--text-dark); font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(72, 201, 176, 0.2); }
        .brand-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .logo-text { font-size: 1.8rem; font-weight: 800; color: var(--accent); letter-spacing: -1px; }
        .logo-sub { color: var(--primary); font-size: 1.8rem; font-weight: 800; }
        .app-title { font-size: 1.5rem; color: var(--primary); font-weight: 300; border-left: 2px solid var(--accent); padding-left: 15px; margin-left: 15px; }
        
        /* Layout */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        
        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi { background: white; padding: 20px; border-radius: 10px; text-align: center; border-bottom: 4px solid var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.04); }
        .kpi-val { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        
        /* Forms & Tables */
        label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--primary); }
        input, select { padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; width: 100%; box-sizing: border-box; background: #fafafa; font-size: 1em; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-accent { background: var(--accent); color: #004d40; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); padding: 5px 10px; font-size: 0.8em; }
        
        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 100%; background: white; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .matrix th, .matrix td { text-align: right; border-right: 1px solid #f5f5f5; }
        .matrix th:first-child, .matrix td:first-child { text-align: left; position: sticky; left: 0; background: white; z-index: 5; border-right: 2px solid var(--accent); font-weight: bold; }
        .val-spent { color: var(--danger); font-size: 0.85em; font-weight: bold; display: block; border-top: 1px dotted #ccc; }
        .money { font-family: monospace; letter-spacing: -0.5px; }

        /* Loader */
        #loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:999; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print { .no-print, .btn { display: none !important; } .card { border: none; box-shadow: none; padding: 0; } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3 style="color:var(--primary); margin-top:20px;">Conectando con la Nube...</h3>
</div>

<div class="container">
    <div class="brand-header">
        <div><span class="logo-text">G&C</span> <span class="logo-sub">SOLUTIONS</span></div>
        <div class="app-title">Control Presupuestal en Nube</div>
        <div style="margin-left:auto" class="no-print">
            <button onclick="syncData()" class="btn btn-primary">ðŸ”„ Actualizar Datos</button>
        </div>
    </div>

    <div class="card no-print" id="configPanel" style="display:none;">
        <h3>ðŸ“‚ Inicializar Base de Datos</h3>
        <p>Sube el archivo <b>BUDGET CODIGOS.csv</b> para comenzar.</p>
        <input type="file" id="csvFile" accept=".csv" style="max-width:300px;">
        <br><br>
        <button onclick="uploadBudgetCSV()" class="btn btn-accent">ðŸš€ Subir a Google Sheets</button>
    </div>

    <div class="kpi-row">
        <div class="kpi">
            <div class="kpi-label">PRESUPUESTO TOTAL</div>
            <div class="kpi-val money" id="kpiTotal">$0</div>
        </div>
        <div class="kpi">
            <div class="kpi-label">DISPONIBLE REAL</div>
            <div class="kpi-val money" id="kpiAvail" style="color:var(--success)">$0</div>
        </div>
        <div class="kpi">
            <div class="kpi-label">% EJECUCIÃ“N</div>
            <div class="kpi-val" id="kpiPerc" style="color:#333">0%</div>
        </div>
    </div>

    <div class="main-grid">
        <div class="card no-print">
            <h3>ðŸ’¸ Registrar Gasto</h3>
            <form onsubmit="addExpense(event)">
                <label>Usuario</label>
                <input type="text" id="userName" placeholder="Ej: Juan Perez" required>
                
                <label>CÃ³digo Presupuestal</label>
                <select id="selCode" required><option value="">-- Cargando... --</option></select>
                
                <label>Referencia / NÂ° OC</label>
                <input type="text" id="ocRef" placeholder="Ej: OC-2025-001" required>

                <div style="display:flex; gap:15px;">
                    <div style="flex:1;"><label>Monto</label><input type="number" id="ocAmount" required min="0"></div>
                    <div style="flex:1;"><label>Fecha</label><input type="date" id="ocDate" required></div>
                </div>
                <br>
                <button type="submit" class="btn btn-accent" style="width:100%">ðŸ’¾ Guardar en Nube</button>
            </form>
        </div>

        <div class="card no-print">
            <h3>ðŸ•’ Ãšltimos Movimientos</h3>
            <div class="table-wrap" style="max-height: 400px;">
                <table id="historyTable">
                    <thead><tr><th>Fecha</th><th>Usuario</th><th>Ref/CÃ³d</th><th>Monto</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ðŸ“… EjecuciÃ³n Mensual</h3>
        <input type="text" id="searchBox" placeholder="Buscar..." style="margin-bottom:10px;" onkeyup="filterTable(this.value)">
        <div class="table-wrap">
            <table id="matrixTable" class="matrix">
                <thead>
                    <tr><th>Cod/Desc</th><th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th><th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th><th>Total</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // =========================================================
    // âš ï¸ PEGA AQUÃ TU URL DE GOOGLE APPS SCRIPT (Entre comillas) âš ï¸
    const API_URL = "https://script.google.com/macros/s/AKfycbwiM8-zOuehpF5MtrneR7fZDxORb8DLWsmiYzm0GqZlxc3lRm6QdQn9OvtRGhasl-g/exec"; 
    // =========================================================

    let budget = [];
    let expenses = [];

    document.addEventListener('DOMContentLoaded', () => {
        const savedUser = localStorage.getItem('gc_username');
        if(savedUser) document.getElementById('userName').value = savedUser;
        document.getElementById('ocDate').valueAsDate = new Date();
        syncData();
    });

    // === COMUNICACIÃ“N BLINDADA (TODO ES POST) ===
    async function apiCall(action, payload = {}) {
        try {
            // 1. Preparamos el paquete de datos
            const body = JSON.stringify({ action: action, ...payload });
            
            // 2. Enviamos como texto plano (text/plain) para evitar bloqueo CORS
            const response = await fetch(API_URL, {
                method: "POST",
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: body
            });

            // 3. Verificamos la respuesta
            const result = await response.json();
            if (result.error) throw new Error(result.error);
            return result;

        } catch (err) {
            console.error("API Error:", err);
            throw err;
        }
    }

// --- SINCRONIZACIÃ“N MODO DIAGNÃ“STICO ---
    async function syncData() {
        showLoader(true);
        const kpiDisplay = document.getElementById('kpiTotal');
        
        try {
            // Imprimimos en pantalla que estamos intentando...
            kpiDisplay.innerText = "Conectando...";
            
            // Verificar que la URL no estÃ© vacÃ­a
            if(API_URL.includes("PEGAR_AQUI") || API_URL.length < 10) {
                throw new Error("La URL del script no se ha configurado en el cÃ³digo.");
            }

            // Intento de conexiÃ³n
            const resB = await fetch(API_URL, {
                method: "POST",
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'readData', sheetName: 'Presupuesto' })
            });

            if (!resB.ok) {
                throw new Error(`Error HTTP: ${resB.status} ${resB.statusText}`);
            }

            const textResponse = await resB.text(); // Leemos como texto primero para ver si es error HTML
            
            let dataB;
            try {
                dataB = JSON.parse(textResponse);
            } catch (e) {
                console.log("Respuesta recibida:", textResponse);
                throw new Error("Google devolviÃ³ texto en vez de datos (Revisa la URL)");
            }

            if (dataB.error) throw new Error(dataB.error);

            budget = Array.isArray(dataB) ? dataB : [];
            
            // Si llegamos aquÃ­, funcionÃ³ el presupuesto, vamos por los gastos
            const resE = await fetch(API_URL, {
                method: "POST",
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'readData', sheetName: 'Gastos' })
            });
            const dataE = await resE.json();
            expenses = Array.isArray(dataE) ? dataE : [];

            renderUI(); // Si todo sale bien, se pinta la tabla

        } catch (err) {
            console.error(err);
            // AQUÃ ESTÃ LA CLAVE: Mostramos el error en grande
            kpiDisplay.innerHTML = `<span style="color:red; font-size:0.5em">${err.message}</span>`;
            alert("FALLO: " + err.message);
        }
        showLoader(false);
    }
    // --- ACCIONES ---
    async function addExpense(e) {
        e.preventDefault();
        showLoader(true);
        const user = document.getElementById('userName').value;
        localStorage.setItem('gc_username', user);

        const data = {
            id: Date.now(),
            user: user,
            code: document.getElementById('selCode').value,
            ref: document.getElementById('ocRef').value,
            amount: parseFloat(document.getElementById('ocAmount').value),
            date: document.getElementById('ocDate').value
        };

        try {
            await apiCall('addExpense', { data: data });
            expenses.push(data); // Optimista
            renderUI();
            document.getElementById('ocRef').value = '';
            document.getElementById('ocAmount').value = '';
            alert("âœ… Guardado.");
        } catch (err) { alert("Error al guardar: " + err.message); }
        showLoader(false);
    }

    async function deleteExpense(id) {
        if(!confirm("Â¿Borrar gasto?")) return;
        showLoader(true);
        try {
            await apiCall('deleteExpense', { id: id });
            expenses = expenses.filter(e => e.id != id);
            renderUI();
        } catch(err) { alert("Error: " + err.message); }
        showLoader(false);
    }

    function uploadBudgetCSV() {
        const file = document.getElementById('csvFile').files[0];
        if(!file) return alert("Selecciona archivo");
        const r = new FileReader();
        r.readAsText(file, "ISO-8859-1");
        r.onload = async function(e) {
            showLoader(true);
            try {
                const lines = processCSV(e.target.result); 
                await apiCall('uploadBudget', { data: lines });
                alert("âœ… Presupuesto subido.");
                syncData();
            } catch(err) { alert("Error: " + err.message); }
            showLoader(false);
        };
    }

    // --- RENDERIZADO ---
    function renderUI() {
        document.getElementById('configPanel').style.display = budget.length ? 'none' : 'block';
        
        // Select
        const sel = document.getElementById('selCode');
        const cv = sel.value;
        sel.innerHTML = '<option value="">-- Seleccionar --</option>';
        budget.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.codigo;
            opt.text = `${b.codigo} - ${b.descripcion ? b.descripcion.substring(0,30) : ''}...`;
            sel.appendChild(opt);
        });
        sel.value = cv;

        // Map Expenses
        const expMap = {};
        let tSpent = 0;
        expenses.forEach(x => {
            if(!x.date) return;
            const dp = x.date.split('-'); 
            if(dp.length === 3) {
                const mid = parseInt(dp[1]) - 1;
                const k = `${x.code}-${mid}`;
                expMap[k] = (expMap[k] || 0) + Number(x.amount);
                tSpent += Number(x.amount);
            }
        });

        // Matrix
        const tbody = document.querySelector('#matrixTable tbody');
        tbody.innerHTML = '';
        let tBud = 0;
        budget.forEach(l => {
            tBud += Number(l.total||0);
            const tr = document.createElement('tr');
            let tds = `<td title="${l.descripcion}"><b>${l.codigo}</b><br><small style="color:#666">${l.descripcion?l.descripcion.substring(0,20):''}...</small></td>`;
            const m = l.monthly || [];
            for(let i=0; i<12; i++) {
                const b = Number(m[i]) || 0;
                const s = expMap[`${l.codigo}-${i}`] || 0;
                const bg = (new Date().getMonth()===i)?'style="background:#f0fbf7"':'';
                tds += `<td ${bg}>${b?fmt(b):'<span style="color:#eee">-</span>'}${s?`<span class="val-spent">${fmt(s)}</span>`:''}</td>`;
            }
            tds += `<td><b>${fmt(l.total)}</b></td>`;
            tr.innerHTML = tds;
            tbody.appendChild(tr);
        });

        // KPIs
        const avail = tBud - tSpent;
        document.getElementById('kpiTotal').innerText = fmtMoney(tBud);
        document.getElementById('kpiAvail').innerText = fmtMoney(avail);
        document.getElementById('kpiAvail').style.color = avail >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('kpiPerc').innerText = tBud > 0 ? ((tSpent/tBud)*100).toFixed(1) + "%" : "0%";

        // Historial
        const hBody = document.querySelector('#historyTable tbody');
        hBody.innerHTML = '';
        [...expenses].sort((a,b)=>b.id-a.id).slice(0,10).forEach(x => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${x.date}</td><td><small>${x.user||'?'}</small></td><td>${x.ref}<br><b>${x.code}</b></td><td class="money">${fmtMoney(x.amount)}</td><td style="text-align:right"><button onclick="deleteExpense(${x.id})" class="btn-danger">Ã—</button></td>`;
            hBody.appendChild(tr);
        });
        
        const f = document.getElementById('searchBox').value;
        if(f) filterTable(f);
    }

    // --- UTILS ---
    function processCSV(text) {
        if(!text) return [];
        const lines = text.split(/\r\n|\n|\r/);
        let sep = ';';
        const fLine = lines.find(l => l && l.length > 5);
        if(fLine && (fLine.match(/,/g)||[]).length > (fLine.match(/;/g)||[]).length) sep = ',';
        
        const res = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].split(sep);
            if(row.length < 2) continue;
            
            const code = String(row[0]||"").replace(/"/g,'').trim();
            const desc = String(row[1]||"").replace(/"/g,'').trim();
            const m = [];
            let t = 0;
            
            for(let k=2; k<=13; k++) {
                let v = String(row[k]||"0");
                v = v.replace(/\./g,'').replace(/,/g,'.').replace(/[^0-9.-]/g,'');
                let num = parseFloat(v) || 0;
                m.push(num); t += num;
            }
            if(code) res.push({ code, desc, monthly: m, total: t });
        }
        return res;
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function fmt(n) { return new Intl.NumberFormat('es-CO', {maximumFractionDigits:0}).format(n); }
    function fmtMoney(n) { return new Intl.NumberFormat('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0}).format(n); }
    function filterTable(v) { 
        v = v.toLowerCase();
        document.querySelectorAll('#matrixTable tbody tr').forEach(r => {
            r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none';
        });
    }
</script>
</body>
</html>


